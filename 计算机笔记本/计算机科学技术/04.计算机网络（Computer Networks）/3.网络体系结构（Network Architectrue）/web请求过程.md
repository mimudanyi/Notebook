# web请求过程

## B/S网络架构概述

B/S网络架构从前端到后端都得到了简化，都基于统一的应用层协议HTTP来交互数据，与大多数传统C/S互联网应用程序采用的长连接的交互模式不同，HTTP协议采用无状态的短连接的通信方式，通常情况下，一次请求就完成了一次数据交互，通常也对应一个业务逻辑，然后这次通信连接就断开了。采用这种方式是为了能够同时服务更多的用户，因为当前互联网应用每天都会处理上亿的用户请求，不可能每个用户访问一次后就一直保持住这个连接。

基于HTTP协议本身的特点，目前的B/S网络架构大都采用类似于下图的架构设计，既要满足海量用户的访问请求，又要保持用户请求的快速响应，所以现在的网络架构也越来越复杂。

![互联网通信流程图](Pictures\互联网通信流程图.png)

##常见请求头、响应头和状态码

![常见请求头和响应头](Pictures\常见THHP头.png)

## DNS域名解析

### DNS域名解析过程

![DNS域名解析](Pictures\DNS域名解析.png)

- 第1步，当用户在浏览器中输入域名并按下回车键后，浏览器会检查缓存中有没有这个域名对应的解析过的IP地址，如果缓存中有，这个解析过程就将结束。浏览器缓存域名也是有限制的，不仅浏览器缓存大小有限制，而且缓存的时间也有限制，通常情况下为几分钟到几小时不等，域名被缓存的时间限制可以通过 TTL属性来设置。这个缓存时间太长和太短都不好，如果缓存时间太长，一旦域名被解析到的IP有变化，会导致被客户端缓存的域名无法解析到变化后的IP地址，以致该域名不能正常解析，这段时间内有可能会有一部分用户无法访问网站。如果时间设置太短，会导致用户每次访问网站都要重新解析一次域名。

- 第2步，如果用户的浏览器缓存中没有，浏览器会查找操作系统缓存中是否有这个域名对应的DNS解析结果。其实操作系统也会有一个域名解析的过程，在Windows中可以通过C:\WindowsSystem32ldriversletclhosts 文件来设置，你可以将任何域名解析到任何能够访问的IP地址。如果你在这里指定了一个域名对应的IP地址，那么浏览器会首先使用这个IP地址。例如，我们在测试时可以将一个域名解析到一台测试服务器上，这样不用修改任何代码就能测试到单独服务器上的代码的业务逻辑是否正确。正是因为有这种本地DNS解析的规程,所以黑客就有可能通过修改你的域名解析来把特定的域名解析到它指定的IP地址上，导致这些域名被劫持。这导致早期的Windows版本中出现过很严重的问题,而且对于一般没有太多电脑知识的用户来说，出现问题后很难发现，即使发现也很难自己解决，所以 Windows 7中将hosts文件设置成了只读的，防止这个文件被轻易修改。在Linux 中这个配置文件是/etc/named.conf，修改这个文件可以达到同样的目的，当解析到这个配置文件中的某个域名时，操作系统会在缓存中缓存这个解析结果，缓存的时间同样是受这个域名的失效时间和缓存的空间大小控制的。前面这两个步骤都是在本机完成的，所以在上图中没有表示出来。到这里还没有涉及真正的域名解析服务器，如果在本机中仍然无法完成域名的解析，就会真正请求域名服务器来解析这个域名了。

- 第3步，如何、怎么知道域名服务器呢？在我们的网络配置中都会有 “DNS服务器地址” 这一项，这个地址就用于解决前面所说的如果两个过程无法解析时要怎么办，操作系统会把这个域名发送给这里设置的 LDNS，也就是本地区的域名服务器。这个 DNS通常都提供给你本地互联网接入的一个DNS解析服务，例如你是在学校接入互联网，那么你的DNS服务器肯定在你的学校，如果你是在一个小区接入互联网的，那这个DNS就是提供给你接入互联网的应用提供商，即电信或者联通，也就是通常所说的SPA，那么这个DNS通常也会在你所在城市的某个角落，通常不会很远。在Windows下可以通过ipconfig查询这个地址，如下图所示。

![](Pictures\ipconfig.png)

- 第4步，如果LDNS仍然没有命中，就直接到Root Server域名服务器请求解析。

- 第5步，根域名服务器返回给本地域名服务器一个所查询域的主域名服务器(gTLD Server）地址。gTLD是国际顶级域名服务器，如.com、.cn、.org 等，全球只有13台左右。

- 第6步，本地域名服务器（Local DNS Server）再向上一步返回的gTLD服务器发送请求。

- 第7步，接受请求的gTLD服务器查找并返回此域名对应的Name Server域名服务器的地址，这个Name Server通常就是你注册的域名服务器，例如你在某个域名服务提供商申请的域名，那么这个域名解析任务就由这个域名提供商的服务器来完成。

- 第8步，Name Server域名服务器会查询存储的域名和IP的映射关系表，正常情况下都根据域名得到目标IP记录，连同一个TTL值返回给DNS Server域名服务器。

- 第9步，返回该域名对应的IP和TTL值，Local DNS Server会缓存这个域名和IP的对应关系，缓存的时间由TTL值控制。

- 第10步，把解析的结果返回给用户，用户根据TTL值缓存在本地系统缓存中，域名解析过程结束。

在实际的DNS解析过程中，可能还不止这10个步骤，如 Name Server也可能有多级，或者有一个GTM来负载均衡控制，这都有可能会影响域名解析的过程。

### DNS域名解析方式

- A记录，A代表的是Address，用来指定域名对应的IP地址，如将item.taobao.com指定到115.238.23.241，将 switch.taobao.com指定到121.14.24.241。A记录可以将多个域名解析到一个IP地址，但是不能将一个域名解析到多个IP地址。
- MX记录，表示的是 Mail Exchange，就是可以将某个域名下的邮件服务器指向自己的Mail Server，如 taobao.com域名的A记录IP地址是115.238.25.245，如果MX记录设置为115.238.25.246，是xxx@taobao.com的邮件路由，DNS会将邮件发送到115.238.25.246所在的服务器，而正常通过Web请求的话仍然解析到A记录的IP地址。
- CNAME记录，全称是Canonical Name（别名解析)。所谓的别名解析就是可以为一个域名设置一个或者多个别名。如将 taobao.com解析到xulingbo.net，将srcfan.com 也解析到xulingbo.net。其中 xulingbo.net分别是taobao.com和 srcfan.com的别名。前面的跟踪域名解析中的“www.taobao.com. 1542 IN CNAME www.gslb.taobao.com”就是CNAME解析。
- NS记录，为某个域名指定DNS解析服务器，也就是这个域名有指定的IP地址的DNS服务器去解析，前面的“gslb.taobao.com. 86400 IN NSgsibns2.taobao.com.”就是NS解析。
- TXT记录，为某个主机名或域名设置说明，如可以为xulingbo.net 设置TXT记录为“君山的博客|许令波”这样的说明。

## CDN工作机制

CDN也就是内容分布网络（Content Delivery Network)，它是构筑在现有Internet 上的一种先进的流量分配网络。其目的是通过在现有的 Internet中增加一层新的网络架构，将网站的内容发布到最接近用户的网络“边缘”，使用户可以就近取得所需的内容，提高用户访问网站的响应速度。有别于镜像，它比镜像更智能，可以做这样一个比喻:CDN =镜像(Mirror)+缓存(Cache)+整体负载均衡(GSLB)。因而，CDN可以明显提高Internet中信息流动的效率。

目前CDN都以缓存网站中的静态数据为主，如 CSs、JS、图片和静态页面等数据。用户在从主站服务器请求到动态内容后再从CDN上下载这些静态数据，从而加速网页数据内容的下载速度，如淘宝有90%以上的数据都是由CDN来提供的。

通常来说CDN要达到以下几个目标。

- 可扩展(Scalability)。性能可扩展性:应对新增的大量数据、用户和事务的扩展能力;成本可扩展性:用低廉的运营成本提供动态的服务能力和高质量的内容分发。
- 安全性(Security)。强调提供物理设备、网络、软件、数据和服务过程的安全性，(趋势）减少因为DDoS攻击或者其他恶意行为造成商业网站的业务中断。
- 可靠性、响应和执行（Reliability、Responsiveness和 Performance)。服务可用性，能够处理可能的故障和用户体验的下降，通过负载均衡及时提供网络的容错机制。

### CDN架构

![CDN架构](Pictures\CDN架构.png)

如图所示，一个用户访问某个静态文件(如 CSS文件)，这个静态文件的域名假如是cdn.taobao.com，那么首先要向Local DNS服务器发起请求，一般经过迭代解析后回到这个域名的注册服务器去解析，一般每个公司都会有一个DNS解析服务器。这时这个DNS解析服务器通常会把它重新CNAME解析到另外一个域名,而这个域名最终会被指向CDN全局中的 DNS负载均衡服务器，再由这个GTM来最终分配是哪个地方的访问用户，返回给离这个访问用户最近的CDN节点。

拿到DNS解析结果，用户就直接去这个CDN节点访问这个静态文件了,如果这个节点中所请求的文件不存在，就会再回到源站去获取这个文件，然后再返回给用户。

### 负载均衡

负载均衡(Load Balance）就是对工作任务进行平衡、分摊到多个操作单元上执行，如图片服务器、应用服务器等，共同完成工作任务。它可以提高服务器响应速度及利用效率，避免软件或者硬件模块出现单点失效，解决网络拥塞问题，实现地理位置无关性，为用户提供较一致的访问质量。

通常有三种负载均衡架构,分别是链路负载均衡、集群负载均衡和操作系统负载均衡。所谓链路负载均衡也就是前面提到的通过DNS解析成不同的IP，然后用户根据这个IP来访问不同的目标服务器，如图所示。

![链路负载均衡](Pictures\链路负载均衡.png)

负载均衡是由DNS 的解析来完成的，用户最终访问哪个Web Server是由 DNS Server来控制的，在这里就是由Global DNS Server来动态解析域名服务。这种 DNS解析的优点是用户会直接访问目标服务器，而不需要经过其他的代理服务器，通常访问速度会更快。但是也有缺点，由于 DNS在用户本地和Local DNS Server都有缓存，一旦某台 Web Server挂掉，那么很难及时更新用户的域名解析结构。如果用户的域名没有及时更新，那么用户将无法访问这个域名，带来的后果非常严重。

集群负载均衡是另外一种常见的负载均衡方式，它一般分为硬件负载均衡和软件负载均衡。硬件负载均衡一般使用一台专门硬件设备来转发请求，如图所示。

![硬件负载均衡](Pictures\硬件负载均衡.png)

硬件负载均衡的关键就是这台价格非常昂贵的设备，如 F5，通常为了安全需要一主一备。它的优点很显然就是性能非常好，缺点就是非常贵，一般公司是用不起的，还有就是当访问量陡然增大超出服务极限时，不能进行动态扩容。

软件负载均衡是使用最普遍的一种负载方式，它的特点是使用成本非常低，直接使用廉价的PC就可以搭建。缺点就是一般一次访问请求要经过多次代理服务器，会增加网络延时。

![软件负载均衡](Pictures\软件负载均衡.png)

图中上面两台是LVS，使用四层负载均衡，也就是在网络层利用P地址进行地址转发。下面三台使用 HAProxy 进行七层负载，也就是可以根据访问用户的HTTP-请求头来进行负载均衡，如可以根据不同的URL来将请求转发到特定机器或者根据用户的Cookie信息来指定访问的机器。

最后一种是操作系统负载均衡，就是利用操作系统级别的软中断或者硬件中断来达到负载均衡，如可以设置多队列网卡等来实现。

这几种负载均衡不仅在CDN的集群中能使用，而且在 Web服务或者分布式数据集群中同样也能使用，但是在这些地方后两种使用得要多一点。